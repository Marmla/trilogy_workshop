---
title: "Trilogy Workshop"
author: "Josh Hagedorn" 
date: "`r Sys.Date()`"
output: 
  html_document:
    code_folding: hide
    theme:
      version: 5
      bootswatch: flatly
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
library(tidyverse)
```

# Load packages and trilogy data sets

Let's start by loading the materials we'll need:

- the R packages we'll use
- the `trilogy` datasets

The main package we'll use is the [tidyverse](https://www.tidyverse.org/), which is actually a collection of R packages with consistent design philosophy, grammar, and data structures.

To pull the current versions of the datasets, we'll follow the steps outlined in the [Getting Started > Use in Reproducible Research](https://github.com/j-hagedorn/trilogy/blob/master/docs/vignettes/getting_started.md#use-in-reproducible-research) vignette.  That's why you'll see a long, alphanumeric code in the links below, specifying precisely what version of the data is being used.

```{r load}
tmi <- read_csv("https://raw.githubusercontent.com/j-hagedorn/trilogy/490a989d199d9440f9210bfe6ede797b03c4e26e/data/tmi.csv")
atu_df <- read_csv("https://raw.githubusercontent.com/j-hagedorn/trilogy/490a989d199d9440f9210bfe6ede797b03c4e26e/data/atu_df.csv")
atu_seq <- read_csv("https://raw.githubusercontent.com/j-hagedorn/trilogy/490a989d199d9440f9210bfe6ede797b03c4e26e/data/atu_seq.csv")
aft <- read_csv("https://raw.githubusercontent.com/j-hagedorn/trilogy/490a989d199d9440f9210bfe6ede797b03c4e26e/data/aft.csv")
```

This allows us to explicitly reference a version of the data so that any research we do can be precisely replicated by others.  For instance, if you wanted to pull an old (and not yet cleaned-up) version of the `aft` dataset, you'd just need to go back in the GitHub history and run the following:

```{r old_aft, eval=FALSE, include=TRUE}
old_aft <- read_csv("https://raw.githubusercontent.com/j-hagedorn/trilogy/f0fb12d108734847114f17980b05686a26305e38/data/aat.csv")
```

# Motifs

The `tmi` is comprised of `r n_distinct(tmi$id)` distinct motifs.^[Recall that Yarlott and Finlayson (2016) counted "46,248 motifs and sub-motifs, 41,796 of which have references to tales or tale types." While there is a difference, it is minimal, and it is unclear what they mean by sub-motifs.]  It is grouped into `r n_distinct(tmi$chapter_id)` chapters, including: *`r paste(unique(tmi$chapter_name), collapse = ", ")`*.

## Hierarchy {.tabset .tabset-pills}

Under the chapter level, it has multiple nested levels of groups, which are named as follows:

- `level_0` = What Thompson labelled 'Grand divisions', sections divisible by 100.
- `level_1` = Smaller divisions end with '0', These are defined at intervals of 10.
- `level_2`-`level_6` = Various sections with multiple layers of subdivisions

### Flat format

The excerpt below shows how this hierarchy structure is represented in the 'flat' dataset:

```{r, layout="l-body-outset"}
tmi %>%
  filter(level_2 == "B122") %>%
  select(chapter_id,id,motif_name,level,starts_with("level_")) %>%
  select(-level_5,-level_6) %>%
  arrange(id) %>%
  rmarkdown::paged_table()
```

### Distribution by level

The most populated level of the index (i.e. '3') is that of the initial *subdivision*, indicating that there are frequently no splits made in the motif identified.  While the index structure would allow for each subsequent level (i.e. levels 4 - 6+) to have increasing numbers of more finely grained motifs, these either do not exist or have not been filled in.

```{r}
tmi %>%
  ggplot(aes(x = level)) +
  geom_histogram(stat="count") +
  theme_minimal() + 
  theme(plot.title.position = "plot") +
  labs(
    title = "Most motifs are in the subdivisions",
    subtitle = "From chapters (level 0) through subdivisions (levels 3-6)",
    x = "Depth within index",
    y = "Distinct motif entries"
  )
```

### Gaps

Note that some motifs are not fit into the hierarchical level format.  This occurs when there is a zero indicator at one of the decimal indices, since this creates a break in the hierarchical structure.  For instance, in the "B122" section, we find B122.1 as a parent motif for B122.1.1-2, but there is no B122.0 to serve as a parent for B122.0.1.

The table below shows how many motifs (i.e. `n_motifs`) are in each chapter, and each level (*if you expand the row*).

```{r tmi_summary_tbl}
library(reactable)
tmi %>%
  group_by(chapter_name,level) %>%
  summarize(n_motifs = n_distinct(id)) %>%
  reactable(
    groupBy = c("chapter_name"),
    columns = list(
      level = colDef(
        aggregate = "count",
        format = list(
          aggregated = colFormat(suffix = " levels")
        )
      ),
      n_motifs = colDef(aggregate = "sum")
    )
  )
```

```{r}
summary_df <-
  tmi %>%
  group_by(chapter_id,chapter_name,level_0,level_1,level_2,level_3) %>%
  summarize(n = n()) %>% 
  ungroup() %>%
  left_join(tmi %>% select(id,level_0_name = motif_name), by = c("level_0" = "id")) %>%
  left_join(tmi %>% select(id,level_1_name = motif_name), by = c("level_1" = "id")) %>%
  left_join(tmi %>% select(id,level_2_name = motif_name), by = c("level_2" = "id")) %>%
  left_join(tmi %>% select(id,level_3_name = motif_name), by = c("level_3" = "id")) %>%
  select(
    starts_with("chapter_"),starts_with("level_0"),
    starts_with("level_1"),starts_with("level_2"),starts_with("level_3"),n
  )
```

---

# Tale Types



# Annotated Tales

- Joining together data sets by primary key
- First analysis: coverage of motif index in the tale type index
- Visualization
- Adding citations
- Where to go next?


---

## Summary Statistics

```{r overlaps}

x <- 
  atu_seq %>% 
  select(motif,atu_id) %>% 
  mutate(in_atu = T) %>%
  left_join(
    aft %>% select(atu_id) %>% mutate(in_aft = T),
    by = "atu_id"
  ) %>%
  distinct(motif, in_atu, in_aft) %>%
  mutate(in_aft = if_else(is.na(in_aft),F,T)) %>%
  # Don't keep multiple rows per motif, count as present (i.e. 'TRUE')
  group_by(motif, in_atu) %>%
  filter(in_aft == max(in_aft))

df <-
  tmi %>%
  select(motif = id) %>%
  distinct(motif) %>%
  left_join(
    x,
    by = "motif"
  ) %>%
  mutate(
    in_tmi = T,
    in_atu = if_else(is.na(in_atu),F,T),
    in_aft = if_else(is.na(in_aft),F,T)
  ) 

sum(df$in_tmi)
sum(df$in_atu)
sum(df$in_aft)

```


```{r anti_joins}
un <-
  atu_seq %>% 
  select(motif) %>%
  distinct() %>%
  anti_join(tmi, by = c("motif" = "id"))

un <-
  aft %>%
  select(atu_id) %>%
  distinct() %>%
  anti_join(atu_seq %>% select(atu_id) %>% distinct(), by = "atu_id")
```


-- How many types vs motifs are in the ATU and the AFT? How many motifs are there in the TMI (answered)? What's the percentage of motifs used in the ATU as contrasted with the TMI (answered)?
-- Where I lost track is the two columns. Eg for the number of ATU types, 2250 is fine, but what is 2249 in the second column plus the remark?
-- Given the 'type = motif string with equiprobable motifs in forkings' working hypothesis, 68245 strings as the answer is well, shocking, but that's it.
-- The next top ten variants seem to refer to the AFT, is that correct? The inserted image has some strange numbers though. First, what does n mean? Or, 46332, which is 1 more than 46331 in the column, which is 110 more than the number of motifs in the TMI?
-- Practically the same question about all the n values in the 2nd column for the top ten, reproducing the image.
-- How many motifs are there in the AFT?
-- How many percent of the TMI motifs (46222) are there in the AFT?
-- How many tale types are there in the AFT?
-- Based on the 2250 ATU type strings, how many possible strings (ways to tell a tale) exist? The suggested number, 68245, is beyond me, please explain your respective reasoning;
-- I cannot decode one of my slide titles, "ATU type combination network (4696 connections among x types)", does that ring a bell? Could x refer to the 2250 types?
-- average number of motifs which constitute a type 
-- the average number of forkings if they can be calculated


